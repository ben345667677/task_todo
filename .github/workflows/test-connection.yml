name: Test SSH Connection

on: 
  workflow_dispatch:  # ×××¤×©×¨ ×œ×”×¨×™×¥ ×™×“× ×™×ª
  push:
    branches:
      - main

jobs:
  test-connection:
    runs-on: ubuntu-latest

    steps:
      # ××©×™×›×ª ×§×•×“ ××”×¨×¤×•
      - uses: actions/checkout@v3

      # ×‘×“×™×§×ª ××©×ª× ×™ ×¡×‘×™×‘×” ×•×—×™×‘×•×¨
      - name: Test Environment Variables and SSH Connection
        run: |
          echo "ğŸ” ×‘×•×“×§ ××©×ª× ×™ ×¡×‘×™×‘×”..."
          echo "SERVER_HOST: ${{ secrets.SERVER_HOST }}"
          echo "SERVER_USER: ${{ secrets.SERVER_USER }}"
          echo "AWS_PEM length: ${#AWS_PEM}"
          
          echo "ğŸ§ª ×‘×•×“×§ ×—×™×‘×•×¨ SSH..."
          
          # ×™×¦×™×¨×ª ×§×•×‘×¥ ××¤×ª×— ×–×× ×™
          echo "${{ secrets.AWS_PEM }}" > /tmp/ssh_key.pem
          chmod 600 /tmp/ssh_key.pem
          
          # ×‘×“×™×§×ª ×—×™×‘×•×¨ SSH
          ssh -o ConnectTimeout=10 \
              -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -i /tmp/ssh_key.pem \
              ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
              "echo 'âœ… ×”×ª×—×‘×¨×ª×™ ×‘×”×¦×œ×—×”!'; whoami; pwd; cat /etc/os-release"
          
          # × ×™×§×•×™ ×§×•×‘×¥ ×”××¤×ª×—
          rm -f /tmp/ssh_key.pem
          
          echo "âœ… ×‘×“×™×§×ª ×—×™×‘×•×¨ ×”×•×©×œ××”!"

      # ×‘×“×™×§×” × ×•×¡×¤×ª ×¢× GitHub Actions
      - name: Test with GitHub Actions SSH
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.AWS_PEM }}
          port: 22
          timeout: 30s
          script: |
            echo "âœ… ×”×ª×—×‘×¨×ª×™ ×¢× GitHub Actions!"
            whoami
            pwd
            echo "ğŸ” ×‘×•×“×§ ××¢×¨×›×ª ×”×¤×¢×œ×”..."
            cat /etc/os-release
            echo "ğŸ” ×‘×•×“×§ Docker..."
            docker --version || echo "Docker ×œ× ××•×ª×§×Ÿ"
            echo "âœ… ×‘×“×™×§×” ×”×•×©×œ××”!"
