name: Test SSH Connection

on: 
  workflow_dispatch:  # מאפשר להריץ ידנית
  push:
    branches:
      - main

jobs:
  test-connection:
    runs-on: ubuntu-latest

    steps:
      # משיכת קוד מהרפו
      - uses: actions/checkout@v3

      # בדיקת משתני סביבה וחיבור
      - name: Test Environment Variables and SSH Connection
        run: |
          echo "🔍 בודק משתני סביבה..."
          echo "SERVER_HOST: ${{ secrets.SERVER_HOST }}"
          echo "SERVER_USER: ${{ secrets.SERVER_USER }}"
          echo "AWS_PEM length: ${#AWS_PEM}"
          
          echo "🧪 בודק חיבור SSH..."
          
          # יצירת קובץ מפתח זמני
          echo "${{ secrets.AWS_PEM }}" > /tmp/ssh_key.pem
          chmod 600 /tmp/ssh_key.pem
          
          # בדיקת חיבור SSH
          ssh -o ConnectTimeout=10 \
              -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -i /tmp/ssh_key.pem \
              ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
              "echo '✅ התחברתי בהצלחה!'; whoami; pwd; cat /etc/os-release"
          
          # ניקוי קובץ המפתח
          rm -f /tmp/ssh_key.pem
          
          echo "✅ בדיקת חיבור הושלמה!"

      # בדיקה נוספת עם GitHub Actions
      - name: Test with GitHub Actions SSH
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.AWS_PEM }}
          port: 22
          timeout: 30s
          script: |
            echo "✅ התחברתי עם GitHub Actions!"
            whoami
            pwd
            echo "🔍 בודק מערכת הפעלה..."
            cat /etc/os-release
            echo "🔍 בודק Docker..."
            docker --version || echo "Docker לא מותקן"
            echo "✅ בדיקה הושלמה!"
