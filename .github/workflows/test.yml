name: Test and Deploy to AWS

on: [push, pull_request]

env:
  AWS_HOST: ec2-13-218-113-24.compute-1.amazonaws.com
  AWS_USER: ec2-user
  AWS_KEY: ${{ secrets.AWS_PEM }}

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Run Test
      timeout-minutes: 15
      run: |
        set -e  # ×™×¦×™××” ×‘×©×’×™××”
        
        echo "Starting Docker services..."
        docker compose up -d
        
        echo "Waiting for services to be ready..."
        sleep 30
        
        echo "Running tests..."
        # ×”×¨×¦×ª ×”×‘×“×™×§×” ×•×©××™×¨×ª ×”×œ×•×’
        if TEST_OUTPUT=$(docker compose run --rm test_client python server_test.py 2>&1); then
          echo "Test command executed successfully"
          echo "Test output: $TEST_OUTPUT"
          
          # ×‘×“×™×§×” ×× ×”×¤×œ×˜ ××›×™×œ "0" (×”×¦×œ×—×”)
          if echo "$TEST_OUTPUT" | grep -q "^0$"; then
            echo "âœ… SUCCESS: Test passed - output contains 0"
          else
            echo "âŒ FAILED: Test failed - output is '$TEST_OUTPUT' (expected 0)"
            docker compose down
            exit 1
          fi
        else
          echo "âŒ FAILED: Test command failed to execute"
          docker compose down
          exit 1
        fi
        
        echo "Cleaning up Docker services..."
        docker compose down
    
    - name: Deploy to AWS EC2
      if: success()
      timeout-minutes: 15
      run: |
        set -e  # ×™×¦×™××” ×‘×©×’×™××”
        
        echo "ğŸš€ Starting AWS deployment..."
        
        # ×™×¦×™×¨×ª ×§×•×‘×¥ ×–×™×¤ ×©×œ ×”×¤×¨×•×™×§×˜
        ZIP_NAME="task_todo_$(date +%Y%m%d_%H%M%S).zip"
        echo "ğŸ“¦ Creating zip file: $ZIP_NAME"
        zip -r $ZIP_NAME . -x "venv/*" "__pycache__/*" "*.pyc" "*.pyo" ".git/*" ".gitignore"
        
        # ×©××™×¨×ª ××¤×ª×— SSH ×–×× ×™
        echo "ğŸ”‘ Setting up SSH key..."
        mkdir -p ~/.ssh
        
        # ×©××™×¨×ª ×”××¤×ª×— ×¢× ×§×™×“×•×“ × ×›×•×Ÿ
        printf '%s\n' "$AWS_KEY" > ~/.ssh/aws_key
        chmod 600 ~/.ssh/aws_key
        
        # ×‘×“×™×§×ª ×”××¤×ª×—
        echo "ğŸ” Checking SSH key format..."
        head -1 ~/.ssh/aws_key
        echo "Key length: $(wc -c < ~/.ssh/aws_key) characters"
        
        # ×‘×“×™×§×ª ×ª×§×™× ×•×ª ×”××¤×ª×—
        echo "ğŸ” Validating SSH key..."
        ssh-keygen -l -f ~/.ssh/aws_key || echo "Key validation failed"
        
        # ×‘×“×™×§×ª ×¡×•×’ ×”××¤×ª×—
        echo "ğŸ” Key type check..."
        if grep -q "BEGIN RSA PRIVATE KEY" ~/.ssh/aws_key; then
            echo "âœ… RSA Private Key detected"
        elif grep -q "BEGIN PRIVATE KEY" ~/.ssh/aws_key; then
            echo "âœ… OpenSSH Private Key detected"
        else
            echo "âŒ Unknown key type"
        fi
        
        # ×”×•×¡×¤×ª AWS host ×œ-known hosts
        ssh-keyscan -H $AWS_HOST >> ~/.ssh/known_hosts
        
        # ×‘×“×™×§×ª ×—×™×‘×•×¨ SSH
        echo "ğŸ” Testing SSH connection..."
        ssh -i ~/.ssh/aws_key -o ConnectTimeout=10 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $AWS_USER@$AWS_HOST "echo 'SSH connection successful'" || {
            echo "âŒ SSH connection failed. Checking key details..."
            echo "Key file exists: $(ls -la ~/.ssh/aws_key)"
            echo "Key permissions: $(stat -c '%a' ~/.ssh/aws_key)"
            echo "First few lines of key:"
            head -3 ~/.ssh/aws_key
            exit 1
        }
        
        # ×”×¢×‘×¨×ª ×§×•×‘×¥ ×”×–×™×¤ ×œ-AWS
        echo "ğŸ“¤ Uploading zip file to AWS..."
        scp -i ~/.ssh/aws_key -o StrictHostKeyChecking=no $ZIP_NAME $AWS_USER@$AWS_HOST:~/
        
        # ×—×™×‘×•×¨ ×œ-AWS ×•×‘×™×¦×•×¢ ×”×¤×¨×™×¡×”
        echo "ğŸ”§ Connecting to AWS and deploying..."
        ssh -i ~/.ssh/aws_key -o StrictHostKeyChecking=no $AWS_USER@$AWS_HOST << ENDSSH
            set -e
            
            echo "ğŸ“ Checking for 'web' directory..."
            if [ ! -d "web" ]; then
                echo "ğŸ“ Creating 'web' directory..."
                mkdir -p web
            fi
            
            echo "ğŸ“‚ Entering 'web' directory..."
            cd web
            
            echo "ğŸ”§ Setting up Docker permissions..."
            # ×”×•×¡×¤×ª ec2-user ×œ×§×‘×•×¦×ª docker
            sudo usermod -aG docker ec2-user || true
            
            # ×”×¤×¢×œ×ª Docker service
            sudo systemctl start docker || true
            sudo systemctl enable docker || true
            
            echo "ğŸ—‘ï¸ Cleaning up old files and containers..."
            # ×¢×¦×™×¨×ª ×•××—×™×§×ª ×›×œ containers
            sudo docker compose down --remove-orphans 2>/dev/null || true
            
            # ××—×™×§×ª ×›×œ images
            sudo docker system prune -a -f
            
            # ××—×™×§×ª ×›×œ ×”×§×‘×¦×™× ×”×™×©× ×™×
            rm -rf * .* 2>/dev/null || true
            
            echo "ğŸ“¦ Extracting new zip file..."
            unzip -q ~/$ZIP_NAME
            
            echo "ğŸ—‘ï¸ Removing zip file..."
            rm ~/$ZIP_NAME
            
            echo "ğŸ³ Running docker compose up with fresh build..."
            sudo docker compose up -d --build --force-recreate
            
            echo "ğŸ“Š Container status:"
            sudo docker compose ps
            
            echo "âœ… Deployment completed successfully!"
            echo "ğŸŒ Application should be available at: http://$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4):5000"
ENDSSH
        
        # × ×™×§×•×™ ××§×•××™
        echo "ğŸ§¹ Cleaning up local files..."
        rm $ZIP_NAME
        rm ~/.ssh/aws_key
        
        echo "ğŸ‰ AWS deployment completed successfully!"