name: Test and Deploy

on: [push, pull_request]

env:
  DOCKER_USERNAME: ben1234561423424
  DOCKER_PASSWORD: dckr_pat_WN5PD44wCjUnAWcqBwTqZgJH__4

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Run Test
      run: |
        docker compose up -d
        sleep 30
        if docker compose run --rm test_client python server_test.py; then
          echo "✅ SUCCESS: Test passed with code 200"
        else
          echo "❌ FAILED: Test failed - no code 200"
          exit 1
        fi
        docker compose down
    
    - name: Login and Push
      if: success()
      run: |
        echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
        docker build -t $DOCKER_USERNAME/task-todo-app:latest .
        docker push $DOCKER_USERNAME/task-todo-app:latest
        echo "✅ DONE - Image uploaded to Docker Hub!"