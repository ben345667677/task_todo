name: Test and Deploy to AWS

on: [push, pull_request]

env:
  AWS_HOST: ec2-13-218-113-24.compute-1.amazonaws.com
  AWS_USER: ec2-user
  AWS_KEY: ${{ secrets.AWS_PEM }}

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Run Test
      timeout-minutes: 15
      run: |
        set -e  # ×™×¦×™××” ×‘×©×’×™××”
        
        echo "Starting Docker services..."
        docker compose up -d
        
        echo "Waiting for services to be ready..."
        sleep 30
        
        echo "Running tests..."
        # ×”×¨×¦×ª ×”×‘×“×™×§×” ×•×©××™×¨×ª ×”×œ×•×’
        if TEST_OUTPUT=$(docker compose run --rm test_client python server_test.py 2>&1); then
          echo "Test command executed successfully"
          echo "Test output: $TEST_OUTPUT"
          
          # ×‘×“×™×§×” ×× ×”×¤×œ×˜ ××›×™×œ "0" (×”×¦×œ×—×”)
          if echo "$TEST_OUTPUT" | grep -q "^0$"; then
            echo "âœ… SUCCESS: Test passed - output contains 0"
          else
            echo "âŒ FAILED: Test failed - output is '$TEST_OUTPUT' (expected 0)"
            docker compose down
            exit 1
          fi
        else
          echo "âŒ FAILED: Test command failed to execute"
          docker compose down
          exit 1
        fi
        
        echo "Cleaning up Docker services..."
        docker compose down
    
    - name: Deploy to AWS EC2
      if: success()
      timeout-minutes: 15
      run: |
        set -e  # ×™×¦×™××” ×‘×©×’×™××”
        
        echo "ğŸš€ Starting AWS deployment with MAXIMUM DEBUG..."
        echo "ğŸ” Environment variables:"
        echo "AWS_HOST: $AWS_HOST"
        echo "AWS_USER: $AWS_USER"
        echo "AWS_KEY length: ${#AWS_KEY} characters"
        
        # ×™×¦×™×¨×ª ×§×•×‘×¥ ×–×™×¤ ×©×œ ×”×¤×¨×•×™×§×˜
        ZIP_NAME="task_todo_$(date +%Y%m%d_%H%M%S).zip"
        echo "ğŸ“¦ Creating zip file: $ZIP_NAME"
        zip -r $ZIP_NAME . -x "venv/*" "__pycache__/*" "*.pyc" "*.pyo" ".git/*" ".gitignore" || {
            echo "âŒ Failed to create zip file"
            exit 1
        }
        echo "âœ… Zip file created successfully: $(ls -la $ZIP_NAME)"
        
        # ×©××™×¨×ª ××¤×ª×— SSH ×–×× ×™
        echo "ğŸ”‘ Setting up SSH key with maximum debugging..."
        mkdir -p ~/.ssh
        echo "ğŸ“ SSH directory created: $(ls -la ~/.ssh)"
        
        # ×©××™×¨×ª ×”××¤×ª×— ×¢× ×§×™×“×•×“ × ×›×•×Ÿ (× ×§×™ ×-\r)
        echo "ğŸ’¾ Saving SSH key..."
        echo "${AWS_KEY}" | tr -d '\r' > ~/.ssh/aws_key || {
            echo "âŒ Failed to save SSH key"
            exit 1
        }
        chmod 600 ~/.ssh/aws_key || {
            echo "âŒ Failed to set SSH key permissions"
            exit 1
        }
        echo "âœ… SSH key saved and permissions set"
        
        # ×‘×“×™×§×ª ×”××¤×ª×—
        echo "ğŸ” Checking SSH key format..."
        echo "Key file exists: $(ls -la ~/.ssh/aws_key)"
        echo "Key permissions: $(stat -c '%a' ~/.ssh/aws_key)"
        echo "Key size: $(wc -c < ~/.ssh/aws_key) characters"
        echo "First line: $(head -1 ~/.ssh/aws_key)"
        echo "Last line: $(tail -1 ~/.ssh/aws_key)"
        
        # ×‘×“×™×§×ª ×ª×§×™× ×•×ª ×”××¤×ª×—
        echo "ğŸ” Validating SSH key..."
        if ssh-keygen -l -f ~/.ssh/aws_key; then
            echo "âœ… SSH key validation successful"
        else
            echo "âŒ SSH key validation failed"
            echo "Key content (first 5 lines):"
            head -5 ~/.ssh/aws_key
            echo "Key content (last 5 lines):"
            tail -5 ~/.ssh/aws_key
            exit 1
        fi
        
        # ×‘×“×™×§×ª ×¡×•×’ ×”××¤×ª×—
        echo "ğŸ” Key type check..."
        if grep -q "BEGIN RSA PRIVATE KEY" ~/.ssh/aws_key; then
            echo "âœ… RSA Private Key detected"
        elif grep -q "BEGIN PRIVATE KEY" ~/.ssh/aws_key; then
            echo "âœ… OpenSSH Private Key detected"
        else
            echo "âŒ Unknown key type - checking content:"
            grep -E "BEGIN.*PRIVATE KEY" ~/.ssh/aws_key || echo "No private key markers found"
            exit 1
        fi
        
        # ×‘×“×™×§×ª ×—×™×‘×•×¨ ×‘×¡×™×¡×™
        echo "ğŸ” Testing raw connectivity..."
        echo "Testing port 22..."
        if nc -vz $AWS_HOST 22; then
            echo "âœ… Port 22 is accessible"
        else
            echo "âŒ Port 22 not accessible - checking if host is reachable"
            if ping -c 3 $AWS_HOST; then
                echo "âœ… Host is reachable but port 22 is closed"
                echo "ğŸ”§ Check Security Group settings for SSH (port 22)"
            else
                echo "âŒ Host is not reachable"
                echo "ğŸ”§ Check if instance is running and has public IP"
            fi
            exit 1
        fi
        
        echo "Testing ping..."
        if ping -c 3 $AWS_HOST; then
            echo "âœ… Ping successful"
        else
            echo "âŒ Ping failed"
            exit 1
        fi
        
        # ×”×•×¡×¤×ª AWS host ×œ-known hosts
        echo "ğŸ” Adding host to known_hosts..."
        ssh-keyscan -H $AWS_HOST >> ~/.ssh/known_hosts || {
            echo "âŒ Failed to add host to known_hosts"
            exit 1
        }
        echo "âœ… Host added to known_hosts"
        
        # ×‘×“×™×§×ª ×—×™×‘×•×¨ SSH ×¢× debug ××œ×
        echo "ğŸ” Testing SSH connection with MAXIMUM debug..."
        echo "SSH command: ssh -vvv -i ~/.ssh/aws_key -o ConnectTimeout=10 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $AWS_USER@$AWS_HOST"
        
        if ssh -vvv -i ~/.ssh/aws_key -o ConnectTimeout=10 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $AWS_USER@$AWS_HOST "echo 'SSH connection successful'"; then
            echo "âœ… SSH connection successful!"
        else
            echo "âŒ SSH connection failed with exit code $?"
            echo "ğŸ” Debugging information:"
            echo "Key file details:"
            ls -la ~/.ssh/aws_key
            echo "Key permissions: $(stat -c '%a' ~/.ssh/aws_key)"
            echo "Key owner: $(stat -c '%U:%G' ~/.ssh/aws_key)"
            echo "First 3 lines of key:"
            head -3 ~/.ssh/aws_key
            echo "Last 3 lines of key:"
            tail -3 ~/.ssh/aws_key
            echo "ğŸ”§ Possible issues:"
            echo "1. Wrong username (try 'ubuntu' instead of 'ec2-user')"
            echo "2. Security Group doesn't allow SSH from GitHub Actions"
            echo "3. Instance is not running"
            echo "4. Wrong private key"
            exit 1
        fi
        
        # ×”×¢×‘×¨×ª ×§×•×‘×¥ ×”×–×™×¤ ×œ-AWS
        echo "ğŸ“¤ Uploading zip file to AWS..."
        if scp -v -i ~/.ssh/aws_key -o StrictHostKeyChecking=no $ZIP_NAME $AWS_USER@$AWS_HOST:~/; then
            echo "âœ… Zip file uploaded successfully"
        else
            echo "âŒ Failed to upload zip file"
            exit 1
        fi
        
        # ×—×™×‘×•×¨ ×œ-AWS ×•×‘×™×¦×•×¢ ×”×¤×¨×™×¡×”
        echo "ğŸ”§ Connecting to AWS and deploying..."
        if ssh -i ~/.ssh/aws_key -o StrictHostKeyChecking=no $AWS_USER@$AWS_HOST << ENDSSH
            set -e
            
            echo "ğŸ“ Current directory: $(pwd)"
            echo "ğŸ“ Home directory contents:"
            ls -la ~/
            
            echo "ğŸ“ Checking for 'web' directory..."
            if [ ! -d "web" ]; then
                echo "ğŸ“ Creating 'web' directory..."
                mkdir -p web || {
                    echo "âŒ Failed to create web directory"
                    exit 1
                }
                echo "âœ… Web directory created"
            else
                echo "âœ… Web directory already exists"
            fi
            
            echo "ğŸ“‚ Entering 'web' directory..."
            cd web || {
                echo "âŒ Failed to enter web directory"
                exit 1
            }
            echo "ğŸ“ Now in: $(pwd)"
            
            echo "ğŸ—‘ï¸ Cleaning up old files..."
            # ××—×™×§×ª ×›×œ ×”×§×‘×¦×™× ×”×™×©× ×™×
            rm -rf * .* 2>/dev/null || true
            echo "âœ… Old files cleaned up"
            
            echo "ğŸ“¦ Extracting new zip file..."
            if unzip -q ~/$ZIP_NAME; then
                echo "âœ… Zip file extracted successfully"
            else
                echo "âŒ Failed to extract zip file"
                echo "Checking if zip file exists:"
                ls -la ~/$ZIP_NAME || echo "Zip file not found"
                exit 1
            fi
            
            echo "ğŸ—‘ï¸ Removing zip file..."
            rm ~/$ZIP_NAME || {
                echo "âŒ Failed to remove zip file"
                exit 1
            }
            echo "âœ… Zip file removed"
            
            echo "âœ… Deployment completed successfully!"
            echo "ğŸ“ Files deployed to: $(pwd)"
            echo "ğŸ“‹ Files in directory:"
            ls -la
            echo "ğŸ“Š Directory size:"
            du -sh .
ENDSSH
        then
            echo "âœ… Remote deployment successful"
        else
            echo "âŒ Remote deployment failed"
            exit 1
        fi
        
        # × ×™×§×•×™ ××§×•××™
        echo "ğŸ§¹ Cleaning up local files..."
        rm $ZIP_NAME || echo "Warning: Failed to remove local zip file"
        rm ~/.ssh/aws_key || echo "Warning: Failed to remove SSH key"
        
        echo "ğŸ‰ AWS deployment completed successfully!"
        echo "ğŸŒ Your application should be available at: http://$AWS_HOST:5000"