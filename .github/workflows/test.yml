name: Test and Deploy to AWS

on: [push, pull_request]

env:
  AWS_HOST: ec2-13-218-113-24.compute-1.amazonaws.com
  AWS_USER: ec2-user
  AWS_KEY: ${{ secrets.AWS_PEM }}

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Run Test
      timeout-minutes: 15
      run: |
        set -e
        
        echo "Starting Docker services..."
        docker compose up -d
        
        echo "Waiting for services to be ready..."
        sleep 30
        
        echo "Running tests..."
        if TEST_OUTPUT=$(docker compose run --rm test_client python server_test.py 2>&1); then
          echo "Test command executed successfully"
          echo "Test output: $TEST_OUTPUT"
          
          if echo "$TEST_OUTPUT" | grep -q "^0$"; then
            echo "âœ… SUCCESS: Test passed - output contains 0"
          else
            echo "âŒ FAILED: Test failed - output is '$TEST_OUTPUT' (expected 0)"
            docker compose down
            exit 1
          fi
        else
          echo "âŒ FAILED: Test command failed to execute"
          docker compose down
          exit 1
        fi
        
        echo "Cleaning up Docker services..."
        docker compose down
    
    - name: Deploy to AWS EC2
      if: success()
      timeout-minutes: 15
      run: |
        set -e
        
        echo "ğŸš€ Starting AWS deployment..."
        
        # ×™×¦×™×¨×ª ×§×•×‘×¥ ×–×™×¤
        ZIP_NAME="task_todo_$(date +%Y%m%d_%H%M%S).zip"
        echo "ğŸ“¦ Creating zip file: $ZIP_NAME"
        zip -r $ZIP_NAME . -x "venv/*" "__pycache__/*" "*.pyc" "*.pyo" ".git/*" ".gitignore"
        
        # ×©××™×¨×ª ××¤×ª×— SSH
        echo "ğŸ”‘ Setting up SSH key..."
        mkdir -p ~/.ssh
        echo "${AWS_KEY}" | tr -d '\r' > ~/.ssh/aws_key
        chmod 600 ~/.ssh/aws_key
        
        # ×‘×“×™×§×ª ×—×™×‘×•×¨ ×‘×¡×™×¡×™
        echo "ğŸ” Testing connectivity..."
        nc -vz $AWS_HOST 22 || {
            echo "âŒ Port 22 not accessible"
            exit 1
        }
        
        # ×‘×“×™×§×ª ping (×œ× ×—×•×¡×)
        echo "Testing ping (optional)..."
        ping -c 3 $AWS_HOST || echo "âš ï¸ Ping failed (expected if ICMP blocked by AWS)" || true
        
        # ×”×•×¡×¤×ª host ×œ-known hosts
        ssh-keyscan -H $AWS_HOST >> ~/.ssh/known_hosts
        
        # ×‘×“×™×§×ª SSH
        echo "ğŸ” Testing SSH connection..."
        if ssh -i ~/.ssh/aws_key -o ConnectTimeout=10 -o StrictHostKeyChecking=no $AWS_USER@$AWS_HOST "echo 'SSH OK' && uname -a"; then
            echo "âœ… SSH connection successful!"
        else
            echo "âŒ SSH failed with $AWS_USER, trying ubuntu..."
            if ssh -i ~/.ssh/aws_key -o ConnectTimeout=10 -o StrictHostKeyChecking=no ubuntu@$AWS_HOST "echo 'SSH OK with ubuntu' && uname -a"; then
                echo "âœ… SSH works with ubuntu user"
                export AWS_USER=ubuntu
            else
                echo "âŒ SSH failed with both users"
                echo "Check: Security Group, instance status, private key"
                exit 1
            fi
        fi
        
        # ×”×¢×‘×¨×ª ×§×‘×¦×™×
        echo "ğŸ“¤ Uploading files..."
        scp -i ~/.ssh/aws_key -o StrictHostKeyChecking=no $ZIP_NAME $AWS_USER@$AWS_HOST:~/
        
        # ×¤×¨×™×¡×”
        echo "ğŸ”§ Deploying to AWS..."
        ssh -i ~/.ssh/aws_key -o StrictHostKeyChecking=no $AWS_USER@$AWS_HOST << ENDSSH
            set -e
            
            echo "ğŸ“ Setting up web directory..."
            mkdir -p web
            cd web
            
            echo "ğŸ—‘ï¸ Cleaning up..."
            rm -rf * .* 2>/dev/null || true
            
            echo "ğŸ“¦ Extracting files..."
            unzip -q ~/$ZIP_NAME
            rm ~/$ZIP_NAME
            
            echo "ğŸ³ Setting up Docker..."
            sudo usermod -aG docker $USER || true
            sudo systemctl start docker || true
            sudo systemctl enable docker || true
            
            echo "ğŸ³ Running docker compose..."
            sudo docker compose down --remove-orphans 2>/dev/null || true
            sudo docker compose up -d --build --force-recreate
            
            echo "ğŸ“Š Container status:"
            sudo docker compose ps
            
            echo "âœ… Deployment completed!"
            echo "ğŸŒ App available at: http://$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4):5000"
        ENDSSH
        
        # × ×™×§×•×™
        echo "ğŸ§¹ Cleaning up..."
        rm $ZIP_NAME
        rm ~/.ssh/aws_key
        
        echo "ğŸ‰ Deployment successful!"