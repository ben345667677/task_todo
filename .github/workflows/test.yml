  name: Test and Deploy

  on: 
    push:
      branches:
        - main
    pull_request:

  jobs:
    test-and-deploy:
      runs-on: ubuntu-latest

      steps:
        # ××©×™×›×ª ×§×•×“ ××”×¨×¤×•
        - uses: actions/checkout@v3

        # ×©×œ×‘ 1: ×œ×”×¨×™×¥ ×‘×“×™×§×•×ª ×¢× Docker Compose
        - name: Run Tests
          run: |
            echo "ğŸš€ ××¨×™× ××ª ×›×œ ×”×§×•× ×˜×™×™× ×¨×™×..."
            docker compose up -d
            
            echo "â³ ××—×›×” ×©×”×©×™×¨×•×ª×™× ×™×”×™×• ××•×›× ×™×..."
            sleep 30
            
            echo "ğŸ§ª ××¨×™×¥ ××ª ×”×‘×“×™×§×•×ª..."
            docker compose run --rm test_client python server_test.py
            TEST_EXIT=$?
            
            echo "ğŸ“œ ×œ×•×’×™× ×©×œ ×›×œ ×”×©×™×¨×•×ª×™×:"
            docker compose logs
            
            if [ $TEST_EXIT -eq 0 ]; then
              echo "âœ… SUCCESS: ×”×‘×“×™×§×•×ª ×¢×‘×¨×• ×‘×”×¦×œ×—×”"
            else
              echo "âŒ FAILED: ×”×‘×“×™×§×•×ª × ×›×©×œ×•"
              docker compose down -v
              exit 1
            fi
            
            echo "ğŸ§¹ ×× ×§×”..."
            docker compose down -v

        # ×©×œ×‘ 2: ×”×ª×—×‘×¨×•×ª ×œ×©×¨×ª ×•×”×›× ×ª ×ª×™×§×™×™×”
        - name: Prepare Remote Server
          if: success()
          uses: appleboy/ssh-action@v0.1.9
          with:
            host: ${{ secrets.SERVER_HOST }}
            username: ${{ secrets.SERVER_USER }}
            key: ${{ secrets.AWS_PEM }}
            script: |
              set -e
              echo "ğŸ”— ×”×ª×—×‘×¨×ª×™ ×œ×©×¨×ª ×‘×”×¦×œ×—×”!"
              
              echo "ğŸ§¹ ×× ×§×” ××ª ×ª×™×§×™×™×ª ×”×¤×¨×•×™×§×˜..."
              cd /home/${{ secrets.SERVER_USER }}/
              rm -rf task_todo_old || true
              mv task_todo task_todo_old || true
              mkdir -p task_todo
              echo "âœ… ×ª×™×§×™×™×” ××•×›× ×”!"

        # ×©×œ×‘ 3: ×”×¢×‘×¨×ª ×§×‘×¦×™ ×”×¤×¨×•×™×§×˜
        - name: Copy Project Files
          if: success()
          uses: appleboy/scp-action@v0.1.4
          with:
            host: ${{ secrets.SERVER_HOST }}
            username: ${{ secrets.SERVER_USER }}
            key: ${{ secrets.AWS_PEM }}
            source: "."
            target: "/home/${{ secrets.SERVER_USER }}/task_todo/"
            strip_components: 1

        # ×©×œ×‘ 4: ×”×ª×§× ×ª Docker ×•×”×¨×¦×ª ×”××¤×œ×™×§×¦×™×”
        - name: Start Application on Server
          if: success()
          uses: appleboy/ssh-action@v0.1.9
          with:
            host: ${{ secrets.SERVER_HOST }}
            username: ${{ secrets.SERVER_USER }}
            key: ${{ secrets.AWS_PEM }}
            script: |
              set -e
              echo "ğŸ” ×‘×•×“×§ ×× Docker ××•×ª×§×Ÿ..."
              if ! command -v docker &> /dev/null; then
                echo "ğŸ³ ××ª×§×™×Ÿ Docker..."
                sudo dnf update
                sudo dnf -y install docker docker-compose
                echo "âœ… Docker ×”×•×ª×§×Ÿ ×‘×”×¦×œ×—×”!"
              else
                echo "âœ… Docker ×›×‘×¨ ××•×ª×§×Ÿ!"
              fi
              
              echo "ğŸ”„ ××¤×¢×™×œ ××ª ×©×™×¨×•×ª Docker..."
              sudo systemctl enable --now docker

              echo "ğŸ“ ×¢×•×‘×¨ ×œ×ª×™×§×™×™×ª ×”×¤×¨×•×™×§×˜..."
              cd /home/${{ secrets.SERVER_USER }}/task_todo
              
              echo "ğŸ›‘ ×¢×•×¦×¨ ×§×•× ×˜×™×™× ×¨×™× ×§×™×™××™×..."
              sudo docker compose down -v || true
              
              echo "ğŸ—ï¸ ×‘×•× ×” ×•××¨×™× ×§×•× ×˜×™×™× ×¨×™× ×—×“×©×™×..."
              sudo docker compose up -d --build
              
              echo "â³ ××—×›×” ×©×”×©×™×¨×•×ª×™× ×™×”×™×• ××•×›× ×™×..."
              sleep 30
              
              echo "ğŸ” ×‘×•×“×§ ×©×”×©×™×¨×•×ª×™× ×¨×¦×™×..."
              sudo docker compose ps

              echo "ğŸ©º ×‘×“×™×§×ª ×‘×¨×™××•×ª..."
              curl -f http://localhost:5000/health || (echo 'âŒ Health check failed' && exit 1)

              echo "âœ… ×”×¤×¨×•×™×§×˜ ×”×•×¢×œ×” ×‘×”×¦×œ×—×” ×œ×©×¨×ª!"
              echo "ğŸŒ ×”××¤×œ×™×§×¦×™×” ×–××™× ×” ×‘×›×ª×•×‘×ª: http://${{ secrets.SERVER_HOST }}:5000"
