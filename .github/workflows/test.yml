  name: Test and Deploy

  on: 
    push:
      branches:
        - main
    pull_request:

  jobs:
    test-and-deploy:
      runs-on: ubuntu-latest

      steps:
        # ××©×™×›×ª ×§×•×“ ××”×¨×¤×•
        - uses: actions/checkout@v3

        # ×©×œ×‘ 1: ×œ×”×¨×™×¥ ×‘×“×™×§×•×ª ×¢× Docker Compose
        - name: Run Tests
          run: |
            echo "ğŸš€ ××¨×™× ××ª ×›×œ ×”×§×•× ×˜×™×™× ×¨×™×..."
            docker compose up -d
            
            echo "â³ ××—×›×” ×©×”×©×™×¨×•×ª×™× ×™×”×™×• ××•×›× ×™×..."
            sleep 30
            
            echo "ğŸ§ª ××¨×™×¥ ××ª ×”×‘×“×™×§×•×ª..."
            docker compose run --rm test_client python server_test.py
            TEST_EXIT=$?
            
            echo "ğŸ“œ ×œ×•×’×™× ×©×œ ×›×œ ×”×©×™×¨×•×ª×™×:"
            docker compose logs
            
            if [ $TEST_EXIT -eq 0 ]; then
              echo "âœ… SUCCESS: ×”×‘×“×™×§×•×ª ×¢×‘×¨×• ×‘×”×¦×œ×—×”"
            else
              echo "âŒ FAILED: ×”×‘×“×™×§×•×ª × ×›×©×œ×•"
              docker compose down -v
              exit 1
            fi
            
            echo "ğŸ§¹ ×× ×§×”..."
            docker compose down -v

        # ×©×œ×‘ 2: ×”×ª×—×‘×¨×•×ª ×œ×©×¨×ª ×•×‘×“×™×§×ª ×ª×œ×•×™×•×ª
        - name: Check Dependencies and Clean
          if: success()
          uses: appleboy/ssh-action@v0.1.9
          with:
            host: ${{ secrets.SERVER_HOST }}
            username: ${{ secrets.SERVER_USER }}
            key: ${{ secrets.AWS_PEM }}
            script: |
              set -e
              echo "ğŸ”— ×”×ª×—×‘×¨×ª×™ ×œ×©×¨×ª ×‘×”×¦×œ×—×”!"
              
              echo "ğŸ” ×‘×•×“×§ ×× Docker ××•×ª×§×Ÿ..."
              if ! command -v docker &> /dev/null; then
                echo "ğŸ³ ××ª×§×™×Ÿ Docker..."
                sudo dnf update -y
                sudo dnf -y install docker 
                echo "âœ… Docker ×”×•×ª×§×Ÿ ×‘×”×¦×œ×—×”!"
              else
                echo "âœ… Docker ×›×‘×¨ ××•×ª×§×Ÿ!"
              fi
              
              echo "ğŸ” ×‘×•×“×§ ×× Docker Compose ××•×ª×§×Ÿ..."
              if ! command -v docker-compose &> /dev/null; then
                echo "ğŸ“¦ ××ª×§×™×Ÿ Docker Compose..."
                sudo curl -L "https://github.com/docker/compose/releases/download/v2.28.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
                sudo chmod +x /usr/local/bin/docker-compose
                echo "âœ… Docker Compose ×”×•×ª×§×Ÿ ×‘×”×¦×œ×—×”!"
              else
                echo "âœ… Docker Compose ×›×‘×¨ ××•×ª×§×Ÿ!"
              fi
              
              echo "ğŸ”„ ××¤×¢×™×œ ××ª ×©×™×¨×•×ª Docker..."
              sudo systemctl enable --now docker
              
              echo "ğŸ§¹ ××•×—×§ ××ª ×ª×™×§×™×™×ª ×”×™×•×–×¨..."
              rm -rf /home/${{ secrets.SERVER_USER }}
              mkdir -p /home/${{ secrets.SERVER_USER }}
              echo "âœ… ×ª×™×§×™×™×” × ×•×§×ª×”!"

        # ×©×œ×‘ 3: ×”×¢×‘×¨×ª ×§×‘×¦×™ ×”×¤×¨×•×™×§×˜
        - name: Copy Project Files
          if: success()
          uses: appleboy/scp-action@v0.1.4
          with:
            host: ${{ secrets.SERVER_HOST }}
            username: ${{ secrets.SERVER_USER }}
            key: ${{ secrets.AWS_PEM }}
            source: "."
            target: "/home/${{ secrets.SERVER_USER }}/"
            strip_components: 1

        # ×©×œ×‘ 4: ×”×¨×¦×ª ×”×¤×¨×•×™×§×˜
        - name: Start Application on Server
          if: success()
          uses: appleboy/ssh-action@v0.1.9
          with:
            host: ${{ secrets.SERVER_HOST }}
            username: ${{ secrets.SERVER_USER }}
            key: ${{ secrets.AWS_PEM }}
            script: |
              set -e
              
              echo "ğŸ“ ×¢×•×‘×¨ ×œ×ª×™×§×™×™×ª ×”×¤×¨×•×™×§×˜..."
              cd /home/${{ secrets.SERVER_USER }}
              
              echo "ğŸ—ï¸ ××¨×™× ××ª ×”×¤×¨×•×™×§×˜..."
              sudo docker-compose up -d --build
              
              echo "â³ ××—×›×” ×©×”×©×™×¨×•×ª×™× ×™×”×™×• ××•×›× ×™×..."
              sleep 30
              
              echo "ğŸ” ×‘×•×“×§ ×©×”×©×™×¨×•×ª×™× ×¨×¦×™×..."
              sudo docker-compose ps

              echo "ğŸ©º ×‘×“×™×§×ª ×‘×¨×™××•×ª..."
              curl -f http://localhost:5000/health || (echo 'âŒ Health check failed' && exit 1)

              echo "âœ… ×”×¤×¨×•×™×§×˜ ×”×•×¢×œ×” ×‘×”×¦×œ×—×” ×œ×©×¨×ª!"
              echo "ğŸŒ ×”××¤×œ×™×§×¦×™×” ×–××™× ×” ×‘×›×ª×•×‘×ª: http://${{ secrets.SERVER_HOST }}:5000"
