name: Test and Deploy

on: 
  push:
    branches:
      - main
  pull_request:

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # משוך את הקוד מ-GitHub
      - uses: actions/checkout@v3

      # שלב 1: להריץ בדיקות עם Docker Compose
      - name: Run Tests
        run: |
          echo "🚀 מרים את כל הקונטיינרים..."
          docker compose up -d
          
          echo "⏳ מחכה שהשירותים יהיו מוכנים..."
          sleep 30
          
          echo "🧪 מריץ את הבדיקות..."
          TEST_OUTPUT=$(docker compose run --rm test_client python server_test.py)
          
          echo "�� לוגים של הקונטיינר test:"
          docker compose logs test_client
          
          echo "�� תוצאת הבדיקה: $TEST_OUTPUT"
          
          if [ "$TEST_OUTPUT" = "0" ]; then
            echo "✅ SUCCESS: הבדיקה עברה בהצלחה - תוצאה 0"
          else
            echo "❌ FAILED: הבדיקה נכשלה - תוצאה $TEST_OUTPUT"
            docker compose down
            exit 1
          fi
          
          echo "🧹 מנקה ומסיים..."
          docker compose down