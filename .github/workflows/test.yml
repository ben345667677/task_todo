name: Test and Deploy

on: 
  push:
    branches:
      - main
  pull_request:

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # ××©×•×š ××ª ×”×§×•×“ ×-GitHub
      - uses: actions/checkout@v3

      # ×©×œ×‘ 1: ×œ×”×¨×™×¥ ×‘×“×™×§×•×ª ×¢× Docker Compose
      - name: Run Tests
        run: |
          echo "ğŸš€ ××¨×™× ××ª ×›×œ ×”×§×•× ×˜×™×™× ×¨×™×..."
          docker compose up -d
          
          echo "â³ ××—×›×” ×©×”×©×™×¨×•×ª×™× ×™×”×™×• ××•×›× ×™×..."
          sleep 30
          
          echo "ğŸ§ª ××¨×™×¥ ××ª ×”×‘×“×™×§×•×ª..."
          TEST_OUTPUT=$(docker compose run --rm test_client python server_test.py)
          
          echo "ï¿½ï¿½ ×œ×•×’×™× ×©×œ ×”×§×•× ×˜×™×™× ×¨ test:"
          docker compose logs test_client
          
          echo "ï¿½ï¿½ ×ª×•×¦××ª ×”×‘×“×™×§×”: $TEST_OUTPUT"
          
          if [ "$TEST_OUTPUT" = "0" ]; then
            echo "âœ… SUCCESS: ×”×‘×“×™×§×” ×¢×‘×¨×” ×‘×”×¦×œ×—×” - ×ª×•×¦××” 0"
          else
            echo "âŒ FAILED: ×”×‘×“×™×§×” × ×›×©×œ×” - ×ª×•×¦××” $TEST_OUTPUT"
            docker compose down
            exit 1
          fi
          
          echo "ğŸ§¹ ×× ×§×” ×•××¡×™×™×..."
          docker compose down